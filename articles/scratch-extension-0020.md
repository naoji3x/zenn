---
title: "Scratchã‚’æ‹¡å¼µã—ã‚ˆã†ï¼(2)åœ°å›³ã‚’è¡¨ç¤º"
emoji: "ğŸ˜¾"
type: "tech"
topics: ["scratch", "CoderDojo", "javascript"]
published: true
---

## ã¯ã˜ã‚ã«

[CoderDojo](https://coderdojo.jp/)ã¨ã„ã†ãƒœãƒ©ãƒ³ãƒ†ã‚£ã‚¢å›£ä½“ã§ã€å­ä¾›é”ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã‚¹ã‚­ãƒ«ç¿’å¾—ã®æ”¯æ´ã‚’ã—ã¦ãŠã‚Šã¾ã™ã€‚ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã®é–‹ç™ºç’°å¢ƒã¯ã€ä¸»ã«[Scratch]((https://scratch.mit.edu))ã‚’ä½¿ã£ã¦ã„ã¾ã™ãŒã€æ¨™æº–æ©Ÿèƒ½ã ã‘ã§ã¯é£½ãè¶³ã‚‰ãšã€ã“ã®ã‚·ãƒªãƒ¼ã‚ºã§ã¯Scratchã®æ‹¡å¼µæ©Ÿèƒ½é–‹ç™ºã«æŒ‘æˆ¦ã—ã¾ã™ï¼ä»Šå›ã¯åœ°å›³è¡¨ç¤ºã«æŒ‘æˆ¦ã—ã¾ã™ã€‚

åœ°å›³è¡¨ç¤ºã®æ‹¡å¼µæ©Ÿèƒ½ã¯ã€Junya Ishiharaã•ã‚“ãŒé–‹ç™ºã—ãŸ[Geo Scratch](https://github.com/geolonia/x-geo-scratch)ãŒã‚ˆãã§ãã¦ã„ã¾ã™ã®ã§ãã¡ã‚‰ã‚’ã”åˆ©ç”¨é ‚ãã®ãŒã‚ªã‚¹ã‚¹ãƒ¡ã§ã™ãŒã€ä»Šå›ã¯ç”»åƒè¡¨ç¤ºã®ç·´ç¿’ã¨ã—ã¦å–ã‚Šçµ„ã‚“ã§ã¿ã¾ã—ãŸã€‚

https://github.com/geolonia/x-geo-scratch

å®Œæˆã—ãŸã‚µã‚¤ãƒˆã¯ã“ã¡ã‚‰ã«ãªã‚Šã¾ã™ã€‚

**[åœ°å›³è¡¨ç¤ºæ‹¡å¼µæ©Ÿèƒ½ä»˜ãScratch](https://naoji3x.github.io/scratch-gui/)**

![åœ°å›³è¡¨ç¤ºæ‹¡å¼µæ©Ÿèƒ½ä»˜ãScratch](/images/scratch-extension-0020/extension.png)
*åœ°å›³è¡¨ç¤ºæ‹¡å¼µæ©Ÿèƒ½ä»˜ãScratch*

æ‹¡å¼µæ©Ÿèƒ½ã‹ã‚‰åœ°å›³ã‚’è¿½åŠ ã™ã‚‹ã¨ã€

- ç·¯åº¦ã€çµŒåº¦ã€ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«(0ã€œ18)ã‚’æŒ‡å®šã—ã¦ã®åœ°å›³ã‚’è¡¨ç¤ºã§ãã¾ã™ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯æ±äº¬éƒ½åºã‚’è¡¨ç¤ºã—ã¾ã™ã€‚â€»ã¡ãªã¿ã«åœ°å›³ã‚’æ¶ˆå»ã™ã‚‹æ©Ÿèƒ½ãŒãªã„ã®ã§ã”æ³¨æ„ä¸‹ã•ã„ã€‚

ä»Šå›è¡¨ç¤ºã™ã‚‹åœ°å›³ã¯ã‚ªãƒ¼ãƒ—ãƒ³ãƒ‡ãƒ¼ã‚¿ã®[Open Street Map](https://www.openstreetmap.org)ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚è‘—ä½œæ¨©ã¯[ã“ã¡ã‚‰](https://www.openstreetmap.org/copyright)ã‚’ã”å‚ç…§ä¸‹ã•ã„ã€‚

### ä¸‹æº–å‚™

ä¸‹æº–å‚™ã¯[(1)å¤©æ°—äºˆå ±ã‚’å–å¾—](https://zenn.dev/naoji/articles/scratch-extension-0010)ã‚’å‚ç…§ä¸‹ã•ã„ã€‚

### scratch-guiå´ã®é–‹ç™º

`scratch-gui/src/lib/libraries/extensions`ã«`openstreetmap`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œã‚Šã¾ã—ã‚‡ã†ã€‚ã“ã®ä¸­ã«Scratchã®æ‹¡å¼µæ©Ÿèƒ½ã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’æ ¼ç´ã—ã¾ã™ã€‚ãƒ©ãƒ¼ã‚¸ã‚µã‚¤ã‚ºã®ã‚¢ã‚¤ã‚³ãƒ³ã¯600px x 372px, ã‚¹ãƒ¢ãƒ¼ãƒ«ã‚µã‚¤ã‚ºã®ã‚¢ã‚¤ã‚³ãƒ³ã¯80px x 80pxã«ãªã‚Šã¾ã™ã€‚

![ãƒ©ãƒ¼ã‚¸ã‚µã‚¤ã‚º](/images/scratch-extension-0020/open-street-map.png)
*ãƒ©ãƒ¼ã‚¸ã‚µã‚¤ã‚º 600px x 372px*

![ã‚¹ãƒ¢ãƒ¼ãƒ«ã‚µã‚¤ã‚º](/images/scratch-extension-0020/open-street-map-small.png)
*ã‚¹ãƒ¢ãƒ¼ãƒ«ã‚µã‚¤ã‚º 80px x 80px*

ã“ã®å¾Œã¯ã€ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®ä¿®æ­£ã«ãªã‚Šã¾ã™ã€‚`scratch-gui/src/lib/libraries/extensions/index.jsx`ã«ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```javascript
...ä¸­ç•¥

import gdxforInsetIconURL from './gdxfor/gdxfor-small.svg';
import gdxforConnectionIconURL from './gdxfor/gdxfor-illustration.svg';
import gdxforConnectionSmallIconURL from './gdxfor/gdxfor-small.svg';

import openMeteoIconURL from './openmeteo/open-meteo.png';
import openMeteoInsetIconURL from './openmeteo/open-meteo-small.png';

import openStreetMapIconURL from './openstreetmap/open-street-map.png'; // ã“ã®è¡Œã‚’è¿½åŠ 
import openStreetMapInsetIconURL from './openstreetmap/open-street-map-small.png'; // ã“ã®è¡Œã‚’è¿½åŠ 

...ä¸­ç•¥

       connectingMessage: (
            <FormattedMessage
                defaultMessage="Connecting"
                description="Message to help people connect to their force and acceleration sensor."
                id="gui.extension.gdxfor.connectingMessage"
            />
        ),
        helpLink: 'https://scratch.mit.edu/vernier'
    },
    {
        name: 'å¤©æ°—äºˆå ±(ã¦ã‚“ãã‚ˆã»ã†)',
        extensionId: 'openMeteo',
        iconURL: openMeteoIconURL,
        insetIconURL: openMeteoInsetIconURL,
        description: 'å¤©æ°—äºˆå ±ã‚’å–å¾—ã—ã¾ã™ï¼ˆã¦ã‚“ãã‚ˆã»ã†ã‚’ã—ã‚…ã¨ãã—ã¾ã™ï¼‰',
        internetConnectionRequired: true,
        featured: true
    },
    // æœ€å¾Œã«ä»¥ä¸‹ã®è¡Œã‚’è¿½åŠ 
    {
        name: 'åœ°å›³(ã¡ãš)',
        extensionId: 'openStreetMap',
        iconURL: openStreetMapIconURL,
        insetIconURL: openStreetMapInsetIconURL,
        description: 'åœ°å›³ã‚’è¡¨ç¤ºã—ã¾ã™ï¼ˆã¡ãšã‚’ã²ã‚‡ã†ã˜ã—ã¾ã™ï¼‰ã€‚åœ°å›³ã®è‘—ä½œæ¨©ã¯https://www.openstreetmap.orgã®copyrightã‚’å‚ç…§ãã ã•ã„ã€‚Â©ï¸OpenStreetMap contributors',
        internetConnectionRequired: true,
        featured: true,
        helpLink: 'https://www.openstreetmap.org/copyright'
    }
    // ã“ã“ã¾ã§
];
```

ä»Šå›ã‚‚ã€å¤šè¨€èªå¯¾å¿œã€ã²ã‚‰ãŒãªè¡¨ç¤ºå¯¾å¿œã¾ã§è¨­å®šã—ãŸã‹ã£ãŸã®ã§ã™ãŒã€è‰²ã€…å¤§å¤‰ãã†ãªãŸã‚æ—¥æœ¬èªè¡¨ç¤ºã®ã¿ã«ã—ã¦ã„ã¾ã™ã€‚

### scratch-vmå´ã®é–‹ç™º

scratch-vmã®é–‹ç™ºã‚‚[(1)å¤©æ°—äºˆå ±ã‚’å–å¾—](https://zenn.dev/naoji/articles/scratch-extension-0010)ã¨åŒæ§˜ã§ã™ã®ã§å‚è€ƒã«ã—ã¦ä¸‹ã•ã„ã€‚ä»Šå›ã¯Open Street Mapã®åœ°å›³è¡¨ç¤ºãŒã‚­ãƒ¢ã§ã™ã®ã§ã€å®Ÿè£…ã®æ¦‚è¦ã‚’ã¾ã¨ã‚ã¾ã™ã€‚

1. Open Street Mapã§ã¯256px x 256pxã®ã‚¿ã‚¤ãƒ«çŠ¶ã®åœ°å›³ã‚’ä»¥ä¸‹ã®APIã§æä¾›ã—ã¾ã™ã€‚
```https://a.tile.openstreetmap.org/[z]/[x]/[y].png```
2. ã“ã“ã§ã€```[z]```ã¯ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«ã€```[x]```ã¯åœ°å›³ã®xæ–¹å‘ã®ã‚¿ã‚¤ãƒ«ç•ªå·ã€```[y]```ã¯yæ–¹å‘ã®ã‚¿ã‚¤ãƒ«ç•ªå·ã«ãªã‚Šã¾ã™ã€‚
3. ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«ãŒ0ã®æ™‚ã¯ã€256px x 256pxã®ï¼‘ã¤ã®ã‚¿ã‚¤ãƒ«ã«å…¨ä¸–ç•Œã®ãƒãƒƒãƒ—ãŒæã‹ã‚Œã€ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«ãŒ1ã®æ™‚ã¯2x2ã®4ã¤ã®ã‚¿ã‚¤ãƒ«ã«å…¨ä¸–ç•ŒãŒæã‹ã‚Œã€ã¨ã€ä»¥é™ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«ãŒå¢—ãˆã‚‹ã”ã¨ã«å€ã€…ã§ã‚¿ã‚¤ãƒ«æ•°ãŒå¢—ãˆã‚‹æ§‹é€ ã§ã™ã€‚
4. ç·¯åº¦ã¨çµŒåº¦ã‹ã‚‰x,yã«ç›¸äº’å¤‰æ›ã™ã‚‹æ–¹æ³•ã«ã¤ãã¾ã—ã¦ã¯[Slippy map tilenames](https://wiki.openstreetmap.org/wiki/Slippy_map_tilenames)ã‚’å‚ç…§ä¸‹ã•ã„ã€‚ã‚³ãƒ¼ãƒ‰ã‚µãƒ³ãƒ—ãƒ«ã‚‚ã‚ã‚Šã¾ã™ã®ã§ã€ã»ã¼ãã®ã¾ã¾æ´»ç”¨ã•ã›ã¦ã„ãŸã ãã¾ã—ãŸã€‚
5. ä»Šå›ã¯ã‚¿ã‚¤ãƒ«ã®å‡¦ç†ãŒè¤‡é›‘ãªãŸã‚ã€ç·¯åº¦ã€çµŒåº¦ã‹ã‚‰è¡¨ç¤ºã™ã‚‹ã‚¿ã‚¤ãƒ«æƒ…å ±ã‚’è¨ˆç®—ã™ã‚‹ã‚¯ãƒ©ã‚¹```TileMap```ã¨ã€ã‚¿ã‚¤ãƒ«æƒ…å ±ã‹ã‚‰åœ°å›³ã‚’å–å¾—ã—ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã™ã‚‹ã‚¯ãƒ©ã‚¹```TileCache```ã‚’ä½œã‚Šã¾ã—ãŸã€‚

https://wiki.openstreetmap.org/wiki/Slippy_map_tilenames

`src/extensions`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«```scratch3_open_street_map```ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã€ä»¥ä¸‹ã®```index.js```, ```tile-map.js```, ```tile-cache.js```ã‚’è¿½åŠ ãã ã•ã„ã€‚

#### index.js

```javascript
const ArgumentType = require('../../extension-support/argument-type');
const BlockType = require('../../extension-support/block-type');
const Cast = require('../../util/cast');
const StageLayering = require('../../engine/stage-layering');
const TileMap = require('./tile-map');
const TileCache = require('./tile-cache');

/**
 * Icon svg to be displayed at the left edge of each extension block, encoded as a data URI.
 * @type {string}
 */
// eslint-disable-next-line max-len
const blockIconURI = 'data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+CjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+Cjxzdmcgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgdmlld0JveD0iMCAwIDQwIDQwIiB2ZXJzaW9uPSIxLjEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHhtbDpzcGFjZT0icHJlc2VydmUiIHhtbG5zOnNlcmlmPSJodHRwOi8vd3d3LnNlcmlmLmNvbS8iIHN0eWxlPSJmaWxsLXJ1bGU6ZXZlbm9kZDtjbGlwLXJ1bGU6ZXZlbm9kZDtzdHJva2UtbGluZWpvaW46cm91bmQ7c3Ryb2tlLW1pdGVybGltaXQ6MjsiPgogICAgPGcgdHJhbnNmb3JtPSJtYXRyaXgoMSwwLDAsMSwtNjEwLC05MCkiPgogICAgICAgIDxnIGlkPSJibG9jay1pY29uIiB0cmFuc2Zvcm09Im1hdHJpeCgxLDAsMCwwLjk1MjM4MSwwLDMuMzMzMzMpIj4KICAgICAgICAgICAgPHJlY3QgeD0iNjEwIiB5PSI5MSIgd2lkdGg9IjQwIiBoZWlnaHQ9IjQyIiBzdHlsZT0iZmlsbDpub25lOyIvPgogICAgICAgICAgICA8ZyB0cmFuc2Zvcm09Im1hdHJpeCgxLjY4NzUsMCwwLDEuNzcxODcsNjE3LDk3LjI5OTkpIj4KICAgICAgICAgICAgICAgIDxwYXRoIGQ9Ik0xNS44MTcsMC4xMTNDMTUuOTMzLDAuMjA4IDE2LDAuMzUgMTYsMC41TDE2LDE0LjVDMTYsMTQuNzM3IDE1LjgzMSwxNC45NDMgMTUuNTk4LDE0Ljk5TDEwLjU5OCwxNS45OUMxMC41MzMsMTYuMDAzIDEwLjQ2NywxNi4wMDMgMTAuNDAyLDE1Ljk5TDUuNSwxNS4wMUwwLjU5OCwxNS45OUMwLjU2NiwxNS45OTYgMC41MzMsMTYgMC41LDE2QzAuMjI2LDE2IDAsMTUuNzc0IDAsMTUuNUwwLDEuNUMwLDEuMjYzIDAuMTY5LDEuMDU3IDAuNDAyLDEuMDFMNS40MDIsMC4wMUM1LjQ2NywtMC4wMDMgNS41MzMsLTAuMDAzIDUuNTk4LDAuMDFMMTAuNSwwLjk5TDE1LjQwMiwwLjAxQzE1LjU0OSwtMC4wMiAxNS43MDEsMC4wMTggMTUuODE3LDAuMTEzWk0xMCwxLjkxTDYsMS4xMUw2LDE0LjA5TDEwLDE0Ljg5TDEwLDEuOTFaTTExLDE0Ljg5TDE1LDE0LjA5TDE1LDEuMTFMMTEsMS45MUwxMSwxNC44OVpNNSwxNC4wOUw1LDEuMTFMMSwxLjkxTDEsMTQuODlMNSwxNC4wOVoiIHN0eWxlPSJmaWxsOndoaXRlOyIvPgogICAgICAgICAgICA8L2c+CiAgICAgICAgPC9nPgogICAgPC9nPgo8L3N2Zz4K';

/**
 * Icon svg to be displayed in the category menu, encoded as a data URI.
 * @type {string}
 */
// eslint-disable-next-line max-len
const menuIconURI = 'data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+CjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+Cjxzdmcgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgdmlld0JveD0iMCAwIDQwIDQwIiB2ZXJzaW9uPSIxLjEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHhtbDpzcGFjZT0icHJlc2VydmUiIHhtbG5zOnNlcmlmPSJodHRwOi8vd3d3LnNlcmlmLmNvbS8iIHN0eWxlPSJmaWxsLXJ1bGU6ZXZlbm9kZDtjbGlwLXJ1bGU6ZXZlbm9kZDtzdHJva2UtbGluZWpvaW46cm91bmQ7c3Ryb2tlLW1pdGVybGltaXQ6MjsiPgogICAgPGcgdHJhbnNmb3JtPSJtYXRyaXgoMSwwLDAsMSwtNjEwLC0xNDApIj4KICAgICAgICA8ZyBpZD0ibWVudS1pY29uIiB0cmFuc2Zvcm09Im1hdHJpeCgxLDAsMCwwLjk1MjM4MSwwLDUzLjMzMzMpIj4KICAgICAgICAgICAgPHJlY3QgeD0iNjEwIiB5PSI5MSIgd2lkdGg9IjQwIiBoZWlnaHQ9IjQyIiBzdHlsZT0iZmlsbDpub25lOyIvPgogICAgICAgICAgICA8Y2xpcFBhdGggaWQ9Il9jbGlwMSI+CiAgICAgICAgICAgICAgICA8cmVjdCB4PSI2MTAiIHk9IjkxIiB3aWR0aD0iNDAiIGhlaWdodD0iNDIiLz4KICAgICAgICAgICAgPC9jbGlwUGF0aD4KICAgICAgICAgICAgPGcgY2xpcC1wYXRoPSJ1cmwoI19jbGlwMSkiPgogICAgICAgICAgICAgICAgPGcgdHJhbnNmb3JtPSJtYXRyaXgoMSwwLDAsMS4wNSwwLC01NikiPgogICAgICAgICAgICAgICAgICAgIDxjaXJjbGUgY3g9IjYzMCIgY3k9IjE2MCIgcj0iMjAiIHN0eWxlPSJmaWxsOnJnYigyNTUsMTgxLDApOyIvPgogICAgICAgICAgICAgICAgPC9nPgogICAgICAgICAgICAgICAgPGcgdHJhbnNmb3JtPSJtYXRyaXgoMS40Mzc1LDAsMCwxLjUwOTM3LDYxOC41LDk5LjkyNTEpIj4KICAgICAgICAgICAgICAgICAgICA8cGF0aCBkPSJNMTUuODE3LDAuMTEzQzE1LjkzMywwLjIwOCAxNiwwLjM1IDE2LDAuNUwxNiwxNC41QzE2LDE0LjczNyAxNS44MzEsMTQuOTQzIDE1LjU5OCwxNC45OUwxMC41OTgsMTUuOTlDMTAuNTMzLDE2LjAwMyAxMC40NjcsMTYuMDAzIDEwLjQwMiwxNS45OUw1LjUsMTUuMDFMMC41OTgsMTUuOTlDMC41NjYsMTUuOTk2IDAuNTMzLDE2IDAuNSwxNkMwLjIyNiwxNiAwLDE1Ljc3NCAwLDE1LjVMMCwxLjVDMCwxLjI2MyAwLjE2OSwxLjA1NyAwLjQwMiwxLjAxTDUuNDAyLDAuMDFDNS40NjcsLTAuMDAzIDUuNTMzLC0wLjAwMyA1LjU5OCwwLjAxTDEwLjUsMC45OUwxNS40MDIsMC4wMUMxNS41NDksLTAuMDIgMTUuNzAxLDAuMDE4IDE1LjgxNywwLjExM1pNMTAsMS45MUw2LDEuMTFMNiwxNC4wOUwxMCwxNC44OUwxMCwxLjkxWk0xMSwxNC44OUwxNSwxNC4wOUwxNSwxLjExTDExLDEuOTFMMTEsMTQuODlaTTUsMTQuMDlMNSwxLjExTDEsMS45MUwxLDE0Ljg5TDUsMTQuMDlaIiBzdHlsZT0iZmlsbDp3aGl0ZTsiLz4KICAgICAgICAgICAgICAgIDwvZz4KICAgICAgICAgICAgPC9nPgogICAgICAgIDwvZz4KICAgIDwvZz4KPC9zdmc+Cg==';

/**
 * Class for the new blocks in Scratch 3.0
 * @param {Runtime} runtime - the runtime instantiating this block package.
 * @constructor
 */
class Scratch3OpenStreetMapBlocks {
    constructor (runtime) {
        /**
         * The runtime instantiating this block package.
         * @type {Runtime}
         */
        this.runtime = runtime;
        this.tileMap = new TileMap();
        this.tileCache = new TileCache();

        this.canvas = document.createElement('canvas');
        this.canvas.width = 480;
        this.canvas.height = 360;
    }

    async drawImages () {
        if (this.runtime.renderer) {
            this.ctx = this.canvas.getContext('2d');

            const promises = [];
            for (const tile of this.tileMap.tiles) {
                promises.push(this.tileCache.getImage(tile.zoom, tile.x, tile.y));
            }

            const images = [];
            for (const promise of promises) {
                images.push(await promise);
            }

            let index = 0;
            for (const tile of this.tileMap.tiles) {
                this.ctx.drawImage(images[index], tile.screenX, tile.screenY);
                ++index;
            }

            // Scratchå›ºæœ‰ã®å‡¦ç†
            this.skinId = this.runtime.renderer.createBitmapSkin(this.canvas, 1);
            const drawableId = this.runtime.renderer.createDrawable(
                StageLayering.BACKGROUND_LAYER
            );
            this.runtime.renderer.updateDrawableProperties(drawableId, {
                skinId: this.skinId
            });
            // ã“ã“ã¾ã§
        }
    }

    drawTileMap (args) {
        const latitude = Cast.toNumber(args.LATITUDE);
        const longitude = Cast.toNumber(args.LONGITUDE);
        const zoom = Cast.toNumber(args.ZOOM);

        this.tileMap.buildTiles(zoom, longitude, latitude, 480, 360);
        this.drawImages();
    }

    /**
     * @returns {object} metadata for this extension and its blocks.
     */
    getInfo () {
        return {
            id: 'openStreetMap',
            name: 'åœ°å›³',
            menuIconURI: menuIconURI,
            blockIconURI: blockIconURI,
            blocks: [
                {
                    opcode: 'drawTileMap',
                    text: 'ç·¯åº¦ [LATITUDE], çµŒåº¦ [LONGITUDE]ã®åœ°å›³ã‚’ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«[ZOOM]ã§è¡¨ç¤ºã™ã‚‹',
                    blockType: BlockType.COMMAND,
                    arguments: {
                        ZOOM: {
                            type: ArgumentType.NUMBER,
                            defaultValue: 18
                        },
                        LATITUDE: {
                            type: ArgumentType.NUMBER,
                            defaultValue: 35.689185
                        },
                        LONGITUDE: {
                            type: ArgumentType.NUMBER,
                            defaultValue: 139.691648
                        }
                    }
                }
            ],
            menus: {
            }
        };
    }
}

module.exports = Scratch3OpenStreetMapBlocks;
```

```index.js```ã®ãƒã‚¤ãƒ³ãƒˆã¯ã€ä»¥ä¸‹ã®Scratchã®æç”»ã‚¨ãƒ³ã‚¸ãƒ³ã‚’ä½¿ã†ã¨ã“ã‚ã§ã€ã“ã®éƒ¨åˆ†ã¯[ã‚¿ã‚³ã‚­ãƒ³ã®Pã‚¹ã‚¯ãƒ¼ãƒ«ãƒ»ãƒ–ãƒ­ã‚°](https://p-school.tacoskingdom.com/developer#blog)ã®è§£èª¬ã‚’å‚è€ƒã«ã•ã›ã¦ã„ãŸã ãã¾ã—ãŸï¼ˆã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã”ã–ã„ã¾ã™ğŸ™‡ï¼‰ã€‚

```javascript
            // Scratchå›ºæœ‰ã®å‡¦ç†
            this.skinId = this.runtime.renderer.createBitmapSkin(this.canvas, 1);
            const drawableId = this.runtime.renderer.createDrawable(
                StageLayering.BACKGROUND_LAYER
            );
            this.runtime.renderer.updateDrawableProperties(drawableId, {
                skinId: this.skinId
            });
            // ã“ã“ã¾ã§
```

#### tile-map.js

```javascript
class TileMap {
    constructor () {
        this.tileSize = 256;
        this.xCount = 0;
        this.yCount = 0;
        this.tiles = [];
    }

    // çµŒåº¦â†’xå¤‰æ›
    longitude2x (lon, zoom) {
        return (Math.floor((lon + 180) / 360 * Math.pow(2, zoom)));
    }

    // ç·¯åº¦â†’yå¤‰æ›
    latitude2y (lat, zoom) {
        const n = lat * Math.PI / 180;
        return (Math.floor((1 - (Math.log(Math.tan(n) + (1 / Math.cos(n))) / Math.PI)) / 2 * Math.pow(2, zoom)));
    }

    // xâ†’çµŒåº¦å¤‰æ›
    x2longitude (x, zoom) {
        return (x / Math.pow(2, zoom) * 360) - 180;
    }

    // yâ†’ç·¯åº¦å¤‰æ›
    y2latitude (y, zoom) {
        const n = Math.PI - (2 * Math.PI * y / Math.pow(2, zoom));
        return (180 / Math.PI * Math.atan(0.5 * (Math.exp(n) - Math.exp(-n))));
    }

    // x, yã‚’countã‹ã‚‰ã¯ã¿å‡ºã¦ã„ã‚‹å ´åˆã«è£œæ­£
    adjust (index, count) {
        // è¨ˆç®—ä¾‹
        // count = 1ã®æ™‚ã¯å¸¸ã«0
        // count = 2, index = -1 ã®æ™‚ã¯1ã‚’è¿”ã™
        // count = 2, index = -2 ã®æ™‚ã¯0ã‚’è¿”ã™
        // count = 2, index = 2 ã®æ™‚ã¯0ã‚’è¿”ã™
        // count = 2, index = 3 ã®æ™‚ã¯1ã‚’è¿”ã™
        if (count === 1) {
            return 0;
        } else if (index >= 0 && index < count) {
            return index;
        }
        const remainder = index % count;

        return (index < 0) ? count + remainder : remainder;
    }

    // screenWidth, screenHeightã‚’åŸ‹ã‚ã‚‹ã‚¿ã‚¤ãƒ«ã‚’è¨ˆç®—ã—tilesã«æ ¼ç´ã™ã‚‹ã€‚
    buildTiles (zoom, centerLongitude, centerLatitude, screenWidth, screenHeight) {
        zoom = Math.round(zoom);
        if (zoom < 0) zoom = 0;
        if (zoom > 18) zoom = 18;

        // ç”»é¢ã®1/2ã«æ•·ãè©°ã‚ã‚‹ã‚¿ã‚¤ãƒ«æ•°ã‚’è¨ˆç®—
        const wHalfCount = Math.ceil(screenWidth / (2 * this.tileSize));
        const hHalfCount = Math.ceil(screenHeight / (2 * this.tileSize));

        // çœŸã‚“ä¸­ã®ã‚¿ã‚¤ãƒ«ã®x, yã‚’æ±‚ã‚ã‚‹
        const xc = this.longitude2x(centerLongitude, zoom);
        const yc = this.latitude2y(centerLatitude, zoom);

        // ç”»é¢ã«è¡¨ç¤ºã™ã‚‹ã‚¿ã‚¤ãƒ«ã®ç¯„å›²ã‚’å–å¾—
        const yMin = yc - hHalfCount;
        const yMax = yc + hHalfCount;
        const xMin = xc - wHalfCount;
        const xMax = xc + wHalfCount;

        // ã‚¿ã‚¤ãƒ«è¡Œåˆ—ã®åˆ—æ•°ã€è¡Œæ•°ã‚’è¨ˆç®—
        this.xCount = xMax - xMin + 1;
        this.yCount = yMax - yMin + 1;
        this.tiles = [];

        // çœŸã‚“ä¸­ã®ã‚¿ã‚¤ãƒ«ã®å·¦ä¸Šã®Woldåº§æ¨™ã‚’æ±‚ã‚ã‚‹
        const lng0 = this.x2longitude(xc, zoom);
        const lat0 = this.y2latitude(yc, zoom);

        // çœŸã‚“ä¸­ã®ã‚¿ã‚¤ãƒ«ã®å³ä¸‹ã®Worldåº§æ¨™ã‚’æ±‚ã‚ã‚‹
        const lng1 = this.x2longitude(xc + 1, zoom);
        const lat1 = this.y2latitude(yc + 1, zoom);

        // ã‚»ãƒ³ã‚¿ãƒ¼ã‚¿ã‚¤ãƒ«ã®è¡¨ç¤ºä½ç½®ã®å·¦ä¸Šã‹ã‚‰ã®ã‚ªãƒ•ã‚»ãƒƒãƒˆï¼ˆç”»é¢åº§æ¨™ç³»ï¼‰ã‚’è¨ˆç®—
        const xOffset = this.tileSize * (centerLongitude - lng0) / (lng1 - lng0);
        const yOffset = this.tileSize * (centerLatitude - lat0) / (lat1 - lat0);

        const count = 2 ** zoom;
        // ç”»é¢ã«è¡¨ç¤ºã™ã‚‹ã‚¿ã‚¤ãƒ«ã‚’åˆ—æŒ™
        let n = 0;
        for (let y = yMin; y <= yMax; ++y) {
            let m = 0;
            for (let x = xMin; x <= xMax; ++x) {
                // ç”»é¢ä¸Šã®xåº§æ¨™ã‚’è¨ˆç®—
                const screenX = -(this.xCount * this.tileSize / 2) +
                (m * this.tileSize) + (this.tileSize / 2) - xOffset + (screenWidth / 2);
                // ç”»é¢ä¸Šã®yåº§æ¨™ã‚’è¨ˆç®—
                const screenY = -(this.yCount * this.tileSize / 2) +
                (n * this.tileSize) + (this.tileSize / 2) - yOffset + (screenHeight / 2);
                this.tiles.push({zoom, x: this.adjust(x, count), y: this.adjust(y, count), screenX, screenY});
                ++m;
            }
            ++n;
        }
    }
}

module.exports = TileMap;
```

#### tile-cache.js

```javascript
class TileCache {
    constructor () {
        this.cache = new Map();
    }

    async getImage (zoom, x, y) {
        const key = `${zoom}-${x}-${y}`;
        const cachedImage = this.cache.get(key);
        if (cachedImage) {
            return cachedImage;
        }

        const img = await this.loadImage(zoom, x, y);
        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã™ã‚‹ç”»åƒã¯100ã¾ã§
        if (this.cache.size >= 100) {
            const deleteKey = this.cache.keys().next().value;
            this.cache.delete(deleteKey);
        }
        this.cache.set(key, img);
        return img;
    }

    loadImage (zoom, x, y) {
        const prefix = 'https://a.tile.openstreetmap.org';
        const suffix = '.png';

        const url = `${prefix}/${zoom}/${x}/${y}${suffix}`;
        return new Promise((resolve, reject) => {
            const img = new Image();
            img.onload = () => resolve(img);
            img.onerror = e => reject(e);
            img.src = url;
            img.crossOrigin = 'Anonymous';
        });
    }
}

module.exports = TileCache;
```

#### extension-manager.jsã¸ã®ç™»éŒ²

ä¸Šè¨˜ã®ã‚³ãƒ¼ãƒ‰ã‚’Scratch-vmã«ç™»éŒ²ã—ã¾ã™ã€‚`src/extension-support/extension-manager.js`ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ä¿®æ­£ã—ã¾ã™ã€‚

```javascript
...ä¸­ç•¥
const builtinExtensions = {
    // This is an example that isn't loaded with the other core blocks,
    // but serves as a reference for loading core blocks as extensions.
    coreExample: () => require('../blocks/scratch3_core_example'),
    // These are the non-core built-in extensions.
    pen: () => require('../extensions/scratch3_pen'),
    wedo2: () => require('../extensions/scratch3_wedo2'),
    music: () => require('../extensions/scratch3_music'),
    microbit: () => require('../extensions/scratch3_microbit'),
    text2speech: () => require('../extensions/scratch3_text2speech'),
    translate: () => require('../extensions/scratch3_translate'),
    videoSensing: () => require('../extensions/scratch3_video_sensing'),
    ev3: () => require('../extensions/scratch3_ev3'),
    makeymakey: () => require('../extensions/scratch3_makeymakey'),
    boost: () => require('../extensions/scratch3_boost'),
    gdxfor: () => require('../extensions/scratch3_gdx_for'),
    openMeteo: () => require('../extensions/scratch3_open_meteo'),
    openStreetMap: () => require('../extensions/scratch3_open_street_map') // <- ã“ã®è¡Œã‚’è¿½åŠ 
};
...ä¸­ç•¥
```

### ãƒ†ã‚¹ãƒˆã€œGitHub Pagesã§ã®å…¬é–‹

[(1)å¤©æ°—äºˆå ±ã‚’å–å¾—](https://zenn.dev/naoji/articles/scratch-extension-0010)ã¨åŒã˜ã§ã™ã®ã§å‚ç…§ä¸‹ã•ã„ã€‚

## ãŠã‚ã‚Šã«

å®Œæˆã—ã¦ã¿ã‚‹ã¨æ¯”è¼ƒçš„ã‚·ãƒ³ãƒ—ãƒ«ãªå®Ÿè£…ã«ã¾ã¨ã¾ã‚Šã¾ã—ãŸãŒã€ã“ã“ã¾ã§æ¥ã‚‹ã®ã«ã ã„ã¶è©¦è¡ŒéŒ¯èª¤ã—ã¾ã—ãŸğŸ˜…ã€‚Javascriptãªã®ã§ã€æœ€åˆã¯[leaflet](https://leafletjs.com/)ã§å®Ÿè£…ã—ã‚ˆã†ã¨æ€ã„ã¾ã—ãŸãŒã€ã€ã€Scratchã®æç”»ã‚¨ãƒ³ã‚¸ãƒ³ã‚’ä½¿ã„ãŸã‹ã£ãŸã®ã§ã€æœ€çµ‚çš„ã«ã¯Open Street Map APIã‹ã‚‰ç”»åƒã‚’å–å¾—ã—ã¦è¡¨ç¤ºã™ã‚‹ã€ä»Šå›ã®å®Ÿè£…æ–¹æ³•ã«è½ã¡ç€ãã¾ã—ãŸã€‚

åœ°å›³ã¯ãƒ”ãƒ³è¡¨ç¤ºãªã©è‰²ã€…å¿œç”¨ãŒè€ƒãˆã‚‰ã‚Œãã†ã§ã™ã®ã§ã€ä»Šå›ã®å®Ÿè£…ã‚’å…ƒã«æ›´ã«ãƒ–ãƒ©ãƒƒã‚·ãƒ¥ã‚¢ãƒƒãƒ—ã—ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ï¼
