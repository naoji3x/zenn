---
title: "Scratchでオリジナルキャラクターを動かそう！ (7) オフィスの激戦"
emoji: "🧑‍💻"
type: "tech"
topics: ["scratch", "CoderDojo", "animation"]
published: true
---

## はじめに

[CoderDojo](https://coderdojo.jp/)というボランティア団体で、子供達のプログラミングスキル習得の支援をしております。プログラミングの開発環境は、主に[Scratch](https://scratch.mit.edu)を使っていますが、チュートリアルの次のレベルの教材を充実させたいと感じており、本シリーズの執筆を開始しました。

今回はゲームのメインロジックである、攻撃の当たり判定とダメージのアニメーションに挑戦します！

## オフィスの激戦

[前回まで](https://zenn.dev/naoji/articles/scratch-telenger-0060)で必殺のデジタル・フラッシュが発射できるようになりましたので、今回は攻撃の当たり判定の後に、ダメージのアニメーションを表示するようにします。Scratchはこの辺りの機能が充実していますので、色々活用したいと思います。今回の成果物は以下になります。

### Scratchのサイト

**[オフィスの激戦](https://scratch.mit.edu/projects/782873425/)**

![オフィスの激戦](/images/scratch-telenger-0070/scratch-telenger-0070-1-fighting.gif)

今回はScratchの以下の機能を活用しています。

1. **スプライトに触れた**: デジタル・フラッシュの`ビーム`と`ハンコまわし`の当たり判定、`テレッド`と`ハンコまわし`との当たり判定に使用します。
2. **色の効果を変える**: ダメージのアニーメーションとして使用します。
3. **メッセージを送る**: デジタル・フラッシュの`ビーム`が触れた時に`ビーム命中`のメッセージを送ります。
4. **ピクセル化の効果を変える**: `ハンコまわし`がダメージを受けた時の効果として画像を粗くします。
5. **画像効果をなくす**: 色の効果、ピクセル化の効果を元に戻します。

## スプライト同士の当たり判定の実装箇所

先ずは、`テレッド`と`ハンコまわし`、`ビーム`と`ハンコまわし`、のスプライト同士が触れたかどうかを判定します。この判定は`調べる`の`〜に触れた`を使います。ちなみに、このブロックはスプライト以外にも、マウスポインターや画面の端に触れた判定も行うことができます。

このブロックを`ずっと`ループで回して、スプライトが触れたかどうかを判定しますが、ここで、このループを攻撃側のスプライトに実装するか、攻撃を受ける側のスプライトに実装するか、検討する必要があります。今回は両方のケースを実装してみました；

- **攻撃を受ける側に実装**: `ハンコまわし`の攻撃を受ける`テレッド`側で触れたかどうかの判定を行うようにしました。
- **攻撃側に実装**： デジタル・フラッシュの`ビーム`側で`ハンコまわし`に触れたかどうかの判定を行い、触れた時に`ビーム命中`のメッセージを送るようにしました。

攻撃側、受けた側どちらに実装するかはケース・バイ・ケースですが、スプライトが触れた後に何らかの処理を実行するスプライト側に実装するのが良さそうです。後でコードを見返して分かりやすいかどうか、など、自分なりの判断基準を持って考えてみましょう。実装のやり方は一種類だけでなく、いくつかの選択肢がありますので、状況に応じて適切な方案を検討しましょう。

![当たり判定の実装場所](/images/scratch-telenger-0070/collision-detection.png)

## テレッドの当たり判定とダメージのアニメーション

`テレッド`側の当たり判定は以下のループで判定し、`ハンコまわし`に触れた際にダメージのアニメーションを表示するようにしています。

1. 旗が押されたきに`ずっと`ループでハンコまわしに触れたかどうかを監視
2. 以下の3,4を5回繰り返します
3. 大きさを一旦小さくしてから大きくし、元の大きさに戻すアニメーションと、
4. 色の効果を変えて七色に変化させます
5. 最後に画像効果をなくしてもとに戻す

![テレッドのコード](/images/scratch-telenger-0070/tel-red-code.png)

ここで、`〇〇効果を△ずつ変える`ブロックを使っていますが、このブロックはスプライトの簡単に見た目を簡単に変えられる便利なブロックです。色を変える以外にも、

1. **魚眼レンズ**:　魚の目で見たような歪んだ形にスプライトを変形
2. **渦巻き**: 渦巻き状にスプライトを変形
3. **ピクセル化**: スプライトをドット絵のように変形
4. **モザイク**: スプライトを縮小してコピーして何個も表示
5. **明るさ**:　スプライトの明るさを変更
6. **幽霊**: 　スプライトの透明度を変更

と様々な効果がありますので色々試してみましょう。なお、この後の`ハンコまわし`のダメージでは「ピクセル化」を使っています。

## デジタル・フラッシュの当たり判定

デジタル・フラッシュの`ビーム`と`ハンコまわし`の当たり判定は`ビーム`のスプライトで行っています。`ビーム`が`ハンコまわし`に触れたら、`ビーム命中`のメッセージを送り、`ビーム`のクローンを削除しています。メッセージについては背景のスクロールでも利用しましたので[こちら](https://zenn.dev/naoji/articles/scratch-telenger-0040)を参照ください。

1. クローンされた後のループの中で、`ハンコまわし`に触れたかどうかを監視
2. `ハンコまわし`に触れたらビーム命中のメッセージを送り
3. このクローン（`ビーム`）を削除する

![ビームのコード](/images/scratch-telenger-0070/beam-code.png)

### ハンコまわしのダメージのアニメーション

`ハンコまわし`のダメージを受けるアニメーションは`ビーム命中`のメッセージを受け取ったときに実行します。ちなみに、スクラッチのメッセージは[イベント駆動型](https://ja.wikipedia.org/wiki/%E3%82%A4%E3%83%99%E3%83%B3%E3%83%88%E9%A7%86%E5%8B%95%E5%9E%8B%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%9F%E3%83%B3%E3%82%B0)というプログラミング手法で、

- イベントに応じた処理を簡潔に書ける、
- 反面、イベントの発生タイミングが処理側で想定できないので、イベントが複雑になると意図しない挙動が発生する

といった特徴があります。実際に今回のダメージ処理も意図しない挙動となりましたので後程紹介します。

`ハンコまわし`のダメージのアニメーションは、見た目と回転の２つを同時に実行しています。

#### 見た目

1. `ビーム命中`を受け取ったら、
2. ピクセル化の効果と色の効果を50ずつ変えるのを5回繰り返し、
3. ピクセル化の効果と色の効果を50ずつ戻し、
4. 画像効果をなくす

#### 回転

1. `ビーム命中`を受け取ったら、
2. 45度回すを10回繰り返します

このように、メッセージを受け取った処理は複数の処理を書くことで、同時に実行することが可能です。

![ハンコまわしのコード](/images/scratch-telenger-0070/stamp-collecting-code.png)

#### ハンコまわしダメージアニメーションの挙動

最後に`ビーム命中`のメッセージを受け取った際の意図しない挙動について紹介します。`ハンコまわし`がダメージを受けている最中にさらにビームを命中させてみて下さい（ちょっと難しいかも・・・）。そうするとピクセル化がさらに進んでいくことがわかると思います。

![意図しない挙動](/images/scratch-telenger-0070/scratch-telenger-0070-2-fighting.gif)

これは`ビーム命中`のメッセージを複数回受け取ったことで、ピクセル化が進んでいる最中にさらにピクセル化が進む、といった現象が起こっています。これはこれで面白いのでOKですが、コードを見ただけでは想定しにくい挙動ですので要注意です。

## おわりに

今回でゲームのイベント処理の中心である当たり判定の実装も完了です！後は攻撃を受けた後にライフを減らすなどの処理を追加していくと、本格的なゲームになっていきます。ゲームの骨格部分は完成が見えてきました！

## Scratchでオリジナルキャラクターを動かそう！ インデックス

[(1) テレんじゃー大地に立つ！（アニメーション）](https://zenn.dev/naoji/articles/scratch-telenger-0010)
[(2) こいつ動くぞ！（キーボードで動かす）](https://zenn.dev/naoji/articles/scratch-telenger-0020)
[(3) 翔べ！テレんじゃー（ジャンプ）](https://zenn.dev/naoji/articles/scratch-telenger-0030)
[(4) 戦場はオフィス（背景を動かす）](https://zenn.dev/naoji/articles/scratch-telenger-0040)
[(5) ハンコの脅威（敵キャラを動かす）](https://zenn.dev/naoji/articles/scratch-telenger-0050)
[(6) 死闘！デジタル・フラッシュ（ビーム発射）](https://zenn.dev/naoji/articles/scratch-telenger-0060)
(7) オフィスの激戦（当たり判定）
